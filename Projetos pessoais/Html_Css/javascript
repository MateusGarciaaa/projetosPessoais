let tarefas = [];
let filtroAtual = 'todas';
const listaTarefas = document.getElementById('listaTarefas');
const entradaTarefa = document.getElementById('entradaTarefa');

// Adiciona tarefa
function adicionarTarefa() {
  const texto = entradaTarefa.value.trim();
  if (!texto) return;

  const novaTarefa = {
    id: Date.now(),
    texto,
    concluida: false
  };

  tarefas.push(novaTarefa);
  entradaTarefa.value = '';
  atualizarLista();
}

// Atualiza lista de tarefas
function atualizarLista() {
  listaTarefas.innerHTML = '';

  const tarefasFiltradas = tarefas.filter(t => {
    if (filtroAtual === 'pendentes') return !t.concluida;
    if (filtroAtual === 'concluidas') return t.concluida;
    return true;
  });

  tarefasFiltradas.forEach(tarefa => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center fade-in';

    const span = document.createElement('span');
    span.textContent = tarefa.texto;
    if (tarefa.concluida) span.classList.add('concluida');

    span.addEventListener('click', () => toggleConcluida(tarefa.id));

    // Clique duplo para editar
    span.addEventListener('dblclick', () => editarTarefa(tarefa, span));

    const btnExcluir = document.createElement('button');
    btnExcluir.className = 'btn btn-sm btn-danger';
    btnExcluir.textContent = 'Excluir';
    btnExcluir.onclick = () => excluirTarefa(tarefa.id, li);

    li.appendChild(span);
    li.appendChild(btnExcluir);
    listaTarefas.appendChild(li);
  });

  // Atualiza filtro ativo visualmente
  document.querySelectorAll('.filtros .btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.textContent.toLowerCase().includes(filtroAtual)) {
      btn.classList.add('active');
    }
  });
}

// Marca ou desmarca como concluída
function toggleConcluida(id) {
  const tarefa = tarefas.find(t => t.id === id);
  if (tarefa) {
    tarefa.concluida = !tarefa.concluida;
    atualizarLista();
  }
}

// Edita tarefa
function editarTarefa(tarefa, span) {
  const input = document.createElement('input');
  input.type = 'text';
  input.value = tarefa.texto;
  input.className = 'editando';

  span.replaceWith(input);
  input.focus();

  input.addEventListener('blur', () => {
    tarefa.texto = input.value.trim() || tarefa.texto;
    atualizarLista();
  });

  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') input.blur();
  });
}

// Exclui tarefa com animação
function excluirTarefa(id, li) {
  li.classList.add('fade-out');
  setTimeout(() => {
    tarefas = tarefas.filter(t => t.id !== id);
    atualizarLista();
  }, 300);
}

// Limpa todas as concluídas
function limparConcluidas() {
  tarefas = tarefas.filter(t => !t.concluida);
  atualizarLista();
}

// Drag and drop com Sortable.js
new Sortable(listaTarefas, {
  animation: 150,
  onEnd: () => {
    const novaOrdem = [];
    document.querySelectorAll('#listaTarefas li').forEach(li => {
      const texto = li.querySelector('span').textContent;
      const tarefa = tarefas.find(t => t.texto === texto);
      if (tarefa) novaOrdem.push(tarefa);
    });
    tarefas = novaOrdem;
  }
});

// Tecla Enter adiciona tarefa
entradaTarefa.addEventListener('keydown', e => {
  if (e.key === 'Enter') adicionarTarefa();
});

// Inicializa
atualizarLista();